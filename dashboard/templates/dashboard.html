<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy Buttons System Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .status-online {
            color: #28a745;
        }
        .status-offline {
            color: #dc3545;
        }
        .status-warning {
            color: #ffc107;
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
        .service-badge {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
        }
        .metric-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        .royal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 10px 10px 0 0;
        }
        .agent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="/">
                <i class="fas fa-crown me-2"></i>
                Happy Buttons GmbH
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">
                    <i class="fas fa-home me-1"></i>Home
                </a>
                <a class="nav-link active" href="/dashboard">
                    <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                </a>
                <a class="nav-link" href="http://localhost:8090/demo-flow" target="_blank">
                    <i class="fas fa-play-circle me-1"></i>Demo Flow
                </a>
                <a class="nav-link" href="/agents">
                    <i class="fas fa-users me-1"></i>Agents
                </a>
                <a class="nav-link" href="/teams">
                    <i class="fas fa-people-group me-1"></i>Teams
                </a>
                <a class="nav-link" href="/config">
                    <i class="fas fa-cog me-1"></i>Config
                </a>
                <span class="navbar-text">
                    <i class="fas fa-clock me-1"></i>
                    <span id="current-time"></span>
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- System Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card metric-card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-microchip fa-2x mb-2"></i>
                        <div class="metric-value" id="cpu-usage">0%</div>
                        <div class="metric-label">CPU Usage</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-memory fa-2x mb-2"></i>
                        <div class="metric-value" id="memory-usage">0%</div>
                        <div class="metric-label">Memory Usage</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-envelope fa-2x mb-2"></i>
                        <div class="metric-value" id="emails-processed">0</div>
                        <div class="metric-label">Emails Processed</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-robot fa-2x mb-2"></i>
                        <div class="metric-value" id="active-agents">0</div>
                        <div class="metric-label">Active Agents</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Services Status -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="royal-header">
                        <h5 class="mb-0">
                            <i class="fas fa-cogs me-2"></i>
                            System Services
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="services-container">
                            <!-- Services will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>
                            System Performance
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-chart-pie me-2"></i>
                            Email Categories
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="emailChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Agents Status -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="royal-header">
                        <h5 class="mb-0">
                            <i class="fas fa-users me-2"></i>
                            Business Unit Agents
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="agent-grid" id="agents-container">
                            <!-- Agents will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Email Tester -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="royal-header">
                        <h5 class="mb-0">
                            <i class="fas fa-envelope-open-text me-2"></i>
                            Email Processing Tester
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="email-test-form">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="test-sender" class="form-label">From</label>
                                        <select class="form-select" id="test-sender">
                                            <option value="john@oem1.com">John Smith &lt;john@oem1.com&gt; (OEM)</option>
                                            <option value="customer@email.com">customer@email.com (Regular)</option>
                                            <option value="unhappy@customer.com">unhappy@customer.com (Complaint)</option>
                                            <option value="supplier@materials.com">supplier@materials.com (Supplier)</option>
                                            <option value="custom">Custom...</option>
                                        </select>
                                        <input type="email" class="form-control mt-2 d-none" id="custom-sender" placeholder="custom@domain.com">
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label for="test-subject" class="form-label">Subject</label>
                                        <input type="text" class="form-control" id="test-subject" value="Test Email Subject">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="test-body" class="form-label">Message Body</label>
                                <textarea class="form-control" id="test-body" rows="3">This is a test email to demonstrate the routing system.</textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane me-2"></i>
                                Test Email Processing
                            </button>
                        </form>
                        <div id="test-results" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Initialize Socket.IO
        const socket = io();

        // Charts
        let performanceChart;
        let emailChart;

        // Data storage
        let systemData = {
            metrics: [],
            services: {},
            emailStats: {},
            agents: {},
            swarm: {}
        };

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            loadInitialData();
            setupEventListeners();
            updateTime();
            setInterval(updateTime, 1000);
        });

        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleTimeString();
        }

        function initializeCharts() {
            // Performance Chart
            const performanceCtx = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(performanceCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'CPU %',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    }, {
                        label: 'Memory %',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });

            // Email Chart
            const emailCtx = document.getElementById('emailChart').getContext('2d');
            emailChart = new Chart(emailCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Orders', 'Complaints', 'Supplier', 'General'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(255, 205, 86, 0.8)',
                            'rgba(75, 192, 192, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function loadInitialData() {
            // Load all data
            Promise.all([
                fetch('/api/metrics').then(r => r.json()),
                fetch('/api/services').then(r => r.json()),
                fetch('/api/email/stats').then(r => r.json()),
                fetch('/api/agents').then(r => r.json()),
                fetch('/api/swarm').then(r => r.json())
            ]).then(([metrics, services, emailStats, agents, swarm]) => {
                updateDashboard({
                    metrics: metrics,
                    services: services,
                    email_stats: emailStats,
                    agents: agents,
                    swarm: swarm
                });
            }).catch(error => {
                console.error('Error loading initial data:', error);
            });
        }

        function setupEventListeners() {
            // Socket.IO events
            socket.on('connect', function() {
                console.log('Connected to dashboard');
            });

            socket.on('auto_update', function(data) {
                updateDashboard(data);
            });

            socket.on('error', function(data) {
                console.error('Dashboard error:', data.message);
            });

            // Email test form
            document.getElementById('test-sender').addEventListener('change', function(e) {
                const customInput = document.getElementById('custom-sender');
                if (e.target.value === 'custom') {
                    customInput.classList.remove('d-none');
                    customInput.required = true;
                } else {
                    customInput.classList.add('d-none');
                    customInput.required = false;
                }
            });

            document.getElementById('email-test-form').addEventListener('submit', function(e) {
                e.preventDefault();
                testEmailProcessing();
            });
        }

        function updateDashboard(data) {
            // Update metrics
            if (data.metrics) {
                updateMetrics(data.metrics);
                updatePerformanceChart(data.metrics);
            }

            // Update services
            if (data.services) {
                updateServices(data.services);
            }

            // Update email stats
            if (data.email_stats) {
                updateEmailStats(data.email_stats);
            }

            // Update agents
            if (data.agents) {
                updateAgents(data.agents);
            }
        }

        function updateMetrics(metrics) {
            if (metrics.system) {
                document.getElementById('cpu-usage').textContent =
                    metrics.system.cpu_percent.toFixed(1) + '%';
                document.getElementById('memory-usage').textContent =
                    metrics.system.memory_percent.toFixed(1) + '%';
            }
        }

        function updatePerformanceChart(metrics) {
            if (!metrics.system) return;

            const time = new Date(metrics.timestamp).toLocaleTimeString();

            performanceChart.data.labels.push(time);
            performanceChart.data.datasets[0].data.push(metrics.system.cpu_percent);
            performanceChart.data.datasets[1].data.push(metrics.system.memory_percent);

            // Keep only last 20 data points
            if (performanceChart.data.labels.length > 20) {
                performanceChart.data.labels.shift();
                performanceChart.data.datasets[0].data.shift();
                performanceChart.data.datasets[1].data.shift();
            }

            performanceChart.update('none');
        }

        function updateServices(services) {
            const container = document.getElementById('services-container');
            container.innerHTML = '';

            Object.entries(services).forEach(([serviceName, service]) => {
                const statusClass = service.status === 'running' ? 'status-online' : 'status-offline';
                const statusIcon = service.status === 'running' ? 'fa-check-circle' : 'fa-times-circle';

                const serviceHTML = `
                    <div class="col-md-4 mb-3">
                        <div class="d-flex align-items-center">
                            <i class="fas ${statusIcon} ${statusClass} fa-2x me-3"></i>
                            <div>
                                <h6 class="mb-0">${service.name}</h6>
                                <small class="text-muted">
                                    Port: ${service.port || 'N/A'} |
                                    Status: <span class="${statusClass}">${service.status}</span>
                                </small>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += serviceHTML;
            });
        }

        function updateEmailStats(emailStats) {
            document.getElementById('emails-processed').textContent = emailStats.total_processed || 0;

            // Update email chart
            if (emailStats.categories) {
                emailChart.data.datasets[0].data = [
                    emailStats.categories.order || 0,
                    emailStats.categories.complaint || 0,
                    emailStats.categories.supplier || 0,
                    emailStats.categories.general || 0
                ];
                emailChart.update();
            }
        }

        function updateAgents(agents) {
            const container = document.getElementById('agents-container');
            container.innerHTML = '';

            let activeCount = 0;
            Object.entries(agents).forEach(([agentName, agent]) => {
                if (agent.active) activeCount++;

                const statusClass = agent.active ? 'status-online' : 'status-offline';
                const statusIcon = agent.active ? 'fa-check-circle' : 'fa-times-circle';

                const agentHTML = `
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas ${statusIcon} ${statusClass} me-2"></i>
                                <h6 class="mb-0">${agent.name}</h6>
                            </div>
                            <small class="text-muted">
                                Tasks: ${agent.processed_tasks || 0} |
                                Errors: ${agent.error_count || 0} |
                                Queue: ${agent.queue_size || 0}
                            </small>
                        </div>
                    </div>
                `;
                container.innerHTML += agentHTML;
            });

            document.getElementById('active-agents').textContent = activeCount;
        }

        function testEmailProcessing() {
            const senderSelect = document.getElementById('test-sender');
            const customSender = document.getElementById('custom-sender');
            const sender = senderSelect.value === 'custom' ? customSender.value : senderSelect.value;
            const subject = document.getElementById('test-subject').value;
            const body = document.getElementById('test-body').value;

            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<div class="alert alert-info">Processing email...</div>';

            fetch('/api/test_email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    sender: sender,
                    subject: subject,
                    body: body
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const result = data.result;
                    resultsDiv.innerHTML = `
                        <div class="alert alert-success">
                            <h6><i class="fas fa-check-circle me-2"></i>Email Processing Complete</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Classification:</strong><br>
                                    Category: ${result.metadata.category}<br>
                                    Priority: ${result.metadata.priority}<br>
                                    OEM Customer: ${result.metadata.is_oem ? 'Yes' : 'No'}<br>
                                    Urgent: ${result.metadata.is_urgent ? 'Yes' : 'No'}<br>
                                    Confidence: ${(result.metadata.confidence * 100).toFixed(1)}%
                                </div>
                                <div class="col-md-6">
                                    <strong>Routing Decision:</strong><br>
                                    Destination: ${result.routing.destination}<br>
                                    SLA: ${result.routing.sla_hours} hours<br>
                                    Template: ${result.template || 'None'}<br>
                                    Reasoning: ${result.routing.reasoning.join(', ')}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error: ${data.error}
                        </div>
                    `;
                }
            })
            .catch(error => {
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Network Error: ${error.message}
                    </div>
                `;
            });
        }
    </script>
</body>
</html>